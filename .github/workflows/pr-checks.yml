name: PR Checks

on:
  pull_request:
    branches: [master]

jobs:
  lint-and-typecheck:
    name: Lint and Type Check
    runs-on: windows-latest

    steps:
      - uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: 20
          cache: "npm"

      - name: Install Dependencies
        run: |
          npm install
          cd frontend && npm install
          cd ../backend && npm install

      - name: Frontend Type Check
        run: cd frontend && npm run build
        env:
          CI: false

      - name: Backend Type Check
        run: cd backend && npm run type-check

  security-scan:
    name: Security Vulnerability Scan
    runs-on: windows-latest

    steps:
      - uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: 20
          cache: "npm"

      - name: Install Dependencies
        run: |
          npm install
          cd frontend && npm install
          cd ../backend && npm install

      - name: Run Security Audit (Root)
        run: npm audit --audit-level=high
        continue-on-error: false

      - name: Run Security Audit (Frontend)
        run: cd frontend && npm audit --audit-level=high
        continue-on-error: false

      - name: Run Security Audit (Backend)
        run: cd backend && npm audit --audit-level=high
        continue-on-error: false

  build-validation:
    name: Build Validation
    runs-on: windows-latest

    steps:
      - uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: 20
          cache: "npm"

      - name: Install Dependencies
        run: |
          npm install
          cd frontend && npm install
          cd ../backend && npm install

      - name: Build Frontend
        run: npm run build:frontend
        env:
          CI: false

      - name: Build Backend
        run: npm run build:backend

      - name: Build Electron
        run: npx tsc -p tsconfig.json

  pr-summary:
    name: PR Check Summary
    runs-on: windows-latest
    needs: [lint-and-typecheck, security-scan, build-validation]
    if: always()

    steps:
      - name: Check Results
        run: |
          if [ "${{ needs.lint-and-typecheck.result }}" != "success" ] || [ "${{ needs.security-scan.result }}" != "success" ] || [ "${{ needs.build-validation.result }}" != "success" ]; then
            echo "❌ One or more PR checks failed"
            exit 1
          else
            echo "✅ All PR checks passed"
          fi
        shell: bash
